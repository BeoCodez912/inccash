<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mini Chain Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#cbd5e1; --text:#e5e7eb; --accent:#22c55e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(160deg,#0b1024,#0f172a 60%); color:var(--text); }
    header { padding:24px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #1f2937; }
    .title { font-size:20px; font-weight:700; letter-spacing:0.3px; }
    .chip { padding:6px 10px; background:#1f2937; border:1px solid #273144; border-radius:999px; font-size:12px; color:var(--muted); }
    main { max-width:1100px; margin:24px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 1fr; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
    .card h2 { margin:0 0 12px; font-size:16px; color:#d1d5db; letter-spacing:0.2px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .stat { background:#0b1222; border:1px solid #1c2740; padding:12px 14px; border-radius:12px; min-width:160px; }
    .stat .label { color:var(--muted); font-size:12px; }
    .stat .val { font-weight:800; font-size:20px; margin-top:4px; }
    input, button { height:40px; border-radius:10px; border:1px solid #263149; background:#0b1222; color:#e5e7eb; padding:0 12px; }
    input::placeholder { color:#7c849b; }
    button { background:linear-gradient(180deg,#1cc87b,#16a34a); border:none; cursor:pointer; font-weight:700; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid #1f2937; font-size:13px; }
    th { text-align:left; color:#9ca3af; font-weight:600; }
    code { background:#0b1222; border:1px solid #1c2740; padding:2px 6px; border-radius:6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <header>
    <div class="title">Mini Chain Dashboard</div>
    <div class="chip" id="chain-id">chain: …</div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>Overview</h2>
        <div class="row" style="margin-bottom:12px;">
          <div class="stat">
            <div class="label">Balance</div>
            <div class="val mono" id="balance">$0.00</div>
          </div>
          <div class="stat">
            <div class="label">Blocks</div>
            <div class="val mono" id="block-count">0</div>
          </div>
          <div class="stat">
            <div class="label">Difficulty</div>
            <div class="val mono" id="difficulty">-</div>
          </div>
        </div>
        <div class="row">
          <button id="refresh">Refresh</button>
          <button id="copy-endpoints" class="secondary">Copy API endpoints</button>
        </div>
      </section>

      <section class="card">
        <h2>Deposit / Mine</h2>
        <div class="row" style="margin-bottom:8px;">
          <input id="tx-id" placeholder="Transaction ID (auto if empty)" style="flex:1; min-width:220px;" />
          <input id="amount" type="number" step="0.01" min="0.01" placeholder="Amount e.g. 5.50" style="width:160px;" />
          <button id="deposit">Deposit</button>
        </div>
        <div class="row" style="color:#9ca3af; font-size:12px;">
          <div>POST <code>/deposit</code> with <code>{"transactionId","amount"}</code></div>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>Blocks</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Tx ID</th>
            <th class="right">Amount</th>
            <th>Hash</th>
            <th>Prev</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="blocks"></tbody>
      </table>
    </section>
  </main>

  <script>
    const $ = (s) => document.querySelector(s);
    const fmt = (n) => "$" + Number(n).toFixed(2);
    const trunc = (s, n=10) => (s && s.length>n ? s.slice(0,n) + "…" : s || "");

    async function getState() {
      const res = await fetch("/state");
      if (!res.ok) throw new Error("Failed to load /state");
      return res.json();
    }

    async function refresh() {
      try {
        const data = await getState();
        const chain = data.blockchain || [];
        $("#balance").textContent = fmt(data.balance ?? 0);
        $("#block-count").textContent = chain.length;
        $("#difficulty").textContent = data.difficulty ?? "-";
        $("#chain-id").textContent = "chain: " + trunc(data.chainId, 16);

        const tbody = $("#blocks");
        tbody.innerHTML = "";
        chain.slice().reverse().forEach(b => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${b.index}</td>
            <td class="mono">${trunc(b.transactionId, 18)}</td>
            <td class="mono right">${fmt(b.amount ?? 0)}</td>
            <td class="mono">${trunc(b.hash, 14)}</td>
            <td class="mono">${trunc(b.prevHash, 14)}</td>
            <td class="mono">${new Date(b.timestamp).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        alert("Failed to load chain. Is the server running?");
      }
    }

    async function deposit() {
      const amount = parseFloat($("#amount").value);
      const txId = $("#tx-id").value.trim() || ("tx-" + Date.now());
      if (!amount || amount <= 0) return alert("Enter a positive amount.");

      try {
        const res = await fetch("/deposit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ transactionId: txId, amount })
        });
        const out = await res.json();
        if (!res.ok) throw new Error(out?.error || "Deposit failed");
        $("#amount").value = "";
        $("#tx-id").value = "";
        await refresh();
      } catch (e) {
        console.error(e);
        alert(e.message || "Deposit failed");
      }
    }

    $("#refresh").addEventListener("click", refresh);
    $("#deposit").addEventListener("click", deposit);
    $("#copy-endpoints").addEventListener("click", () => {
      const base = location.origin;
      const text = [
        `GET  ${base}/state`,
        `GET  ${base}/balance`,
        `POST ${base}/deposit  body: {"transactionId":"tx-123","amount":5.5}`
      ].join("\n");
      navigator.clipboard.writeText(text).then(() => alert("Endpoints copied!"));
    });

    refresh();
  </script>
</body>
</html>
